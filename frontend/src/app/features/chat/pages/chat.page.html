<div class="chat-container">
  <div class="chat-header">
    <div class="header-left">
      <div class="custom-select-container">
        <div class="selected-value" (click)="toggleDropdown($event)">
          {{ store.currentModel().name }}
          <span class="arrow" [class.open]="isDropdownOpen">▼</span>
        </div>

        <div class="custom-options-wrapper" *ngIf="isDropdownOpen">
          <div class="custom-option" *ngFor="let model of models()" (click)="selectModel(model)">
            {{ model.name }}
          </div>
        </div>
      </div>
      <span class="model-description" *ngIf="store.currentModel().description">
        {{ store.currentModel().description }}
      </span>
    </div>

    <span class="status" [class.loading]="store.loading()">
      {{ store.loading() ? 'Thinking...' : 'Ready' }}
    </span>
  </div>

  <div class="chat-window" appAutoScroll (scroll)="onScroll($event)">
    <!-- Loading skeleton -->
    <div *ngIf="store.loading() && !store.hasMessages()" class="skeleton-container">
      <app-skeleton height="60px" *ngFor="let item of [1, 2, 3]"></app-skeleton>
    </div>

    <!-- Empty state -->
    <div *ngIf="store.isEmpty()" class="empty-state">
      <h3>Start a conversation</h3>
      <p>Select a model and send your first message</p>
    </div>

    <!-- Messages -->
    <div class="messages-container" *ngIf="store.hasMessages()">
      <app-chat-message-bubble
        *ngFor="let msg of store.messageList(); let i = index"
        [message]="msg"
        [isLastUserMessage]="isLastUserMessage(msg, i)"
        (editAndResend)="onEditAndResend($event.content, $event.attachment)"
      />

      <div class="typing-indicator" *ngIf="isTyping">
        <span class="dot"></span>
        <span class="dot"></span>
        <span class="dot"></span>
        <span class="dot"></span>
      </div>
    </div>
  </div>

  <app-error-banner [message]="store.error()" />

  <div class="chat-input-wrapper">
    <div class="chat-button-wrapper">
      <button
        class="header-toggle-btn"
        [class.active]="store.followUpEnabled()"
        (click)="store.toggleFollowUp()"
        [attr.aria-pressed]="store.followUpEnabled()"
        title="Toggle follow-up context"
        aria-label="Toggle follow-up context"
      >
        Follow-UP
      </button>

      <button
        class="header-toggle-btn"
        [class.active]="store.reasoningEnabled()"
        (click)="store.toggleReasoning()"
        [attr.aria-pressed]="store.reasoningEnabled()"
        title="Toggle reasoning generation"
        aria-label="Toggle reasoning generation"
      >
        Reasoning
      </button>
    </div>
    <div class="chat-input">
      <div class="file-input-wrapper">
        <input
          #fileInput
          class="file-input"
          type="file"
          accept=".txt,.md,.json,.csv,.log,.html,.css,.ts,.js,.py,.yaml,.yml,.pdf,.doc,.docx,text/*,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document"
          (change)="onFileSelected($event)"
          [disabled]="store.loading()"
        />

        <app-button
          *ngIf="!selectedFileName()"
          class="btn-upload"
          title="Upload file"
          (click)="fileInput.click()"
          [disabled]="store.loading()"
        >
          +
        </app-button>

        <app-button
          *ngIf="selectedFileName()"
          class="btn-remove"
          title="Remove file"
          (click)="clearFile()"
          [disabled]="store.loading()"
        >
          ✖
        </app-button>
      </div>

      <textarea
        #chatTextarea
        appAutoFocus
        appAutoResize
        [(ngModel)]="message"
        placeholder="Type your message... (Shift + Enter for new line)"
        rows="1"
        [disabled]="store.loading()"
        (keydown)="onKeyDown($event)"
        (ngModelChange)="triggerResize()"
      ></textarea>

      <div class="input-actions">
        <app-button *ngIf="store.loading()" (click)="store.stop()" title="Stop generation">
          Stop
        </app-button>

        <app-button
          *ngIf="!store.loading()"
          class="btn-send"
          (click)="send()"
          [disabled]="!message.trim() || isFileUploading()"
        >
          Send
        </app-button>
      </div>
    </div>

    <div class="file-meta" *ngIf="selectedFileName() || fileError()">
      <span *ngIf="selectedFileName()">Attached: {{ selectedFileName() }}</span>
      <span *ngIf="fileError()" class="file-error">{{ fileError() }}</span>
    </div>
  </div>
</div>

<!-- Error boundary -->
<app-error-boundary
  *ngIf="store.error() && !isErrorDismissed()"
  [error]="store.error()"
  (retry)="retryLoadSessions()"
  (close)="dismissError()"
>
</app-error-boundary>
