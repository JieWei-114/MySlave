<div class="rules-container">
  <!-- Loading State -->
  @if (rulesStore.loading()) {
    <div class="rules-loading">
      <p>Loading session rules...</p>
    </div>
  }

  <!-- Error State -->
  @if (rulesStore.error()) {
    <div class="rules-error">
      <p>{{ rulesStore.error() }}</p>
    </div>
  }

  <!-- Success State -->
  @if (rulesStore.saved()) {
    <div class="rules-success">
      <p>Rules saved successfully</p>
    </div>
  }

  <!-- Rules Content -->
  <div class="rules-wrapper">
    @if (rulesStore.currentSessionId()) {
      <div class="session-rules-header">
        <div class="session-info">
          <h3>Session Rules & Settings</h3>
          <p>Customize search providers, limits, and AI behavior for this chat session</p>
        </div>
        <button class="reset-button" (click)="resetToDefaults()" title="Reset to default settings">
          Reset to Defaults
        </button>
      </div>

      <!-- Active Providers Summary -->
      @if (hasSearchEnabled() && enabledSearchProviders().length > 0) {
        <div class="providers-summary">
          <span class="summary-label">Active Search:</span>
          <span class="summary-value">{{ enabledSearchProviders().join(', ') }}</span>
        </div>
      }
      @if (!hasSearchEnabled()) {
        <div class="providers-warning">
          No search providers enabled. Web search will not work.
        </div>
      }
    }

    <!-- Web Search Providers Section -->
    <div class="rules-section">
      <h3>Web Search Providers</h3>
      <p class="section-description">
        Enable or disable search providers for web queries. 
        <span class="info-badge">Free providers enabled by default</span>
      </p>

      <div class="rule-item">
        <div class="rule-info">
          <span class="rule-name">SearXNG <span class="badge badge-free">FREE</span></span>
          <span class="rule-desc">Privacy-focused meta-search engine (Self-hosted)</span>
        </div>
        <label class="toggle-switch">
          <input
            type="checkbox"
            [checked]="rulesStore.rules()?.searxng ?? false"
            (change)="toggleSessionRule('searxng')"
          />
          <span class="slider"></span>
        </label>
      </div>

      <div class="rule-item">
        <div class="rule-info">
          <span class="rule-name">DuckDuckGo <span class="badge badge-free">FREE</span></span>
          <span class="rule-desc">Privacy-focused search engine (No API key required)</span>
        </div>
        <label class="toggle-switch">
          <input
            type="checkbox"
            [checked]="rulesStore.rules()?.duckduckgo ?? false"
            (change)="toggleSessionRule('duckduckgo')"
          />
          <span class="slider"></span>
        </label>
      </div>

      <div class="rule-item">
        <div class="rule-info">
          <span class="rule-name">Tavily <span class="badge badge-paid">API KEY</span></span>
          <span class="rule-desc">AI-powered research search (Requires API key in backend .env)</span>
        </div>
        <label class="toggle-switch">
          <input
            type="checkbox"
            [checked]="rulesStore.rules()?.tavily ?? false"
            (change)="toggleSessionRule('tavily')"
          />
          <span class="slider"></span>
        </label>
      </div>

      <div class="rule-item">
        <div class="rule-info">
          <span class="rule-name">Serper <span class="badge badge-paid">API KEY</span></span>
          <span class="rule-desc">Google Search API (Requires API key in backend .env)</span>
        </div>
        <label class="toggle-switch">
          <input
            type="checkbox"
            [checked]="rulesStore.rules()?.serper ?? false"
            (change)="toggleSessionRule('serper')"
          />
          <span class="slider"></span>
        </label>
      </div>

      <!-- Advance Search Toggle -->
      <div class="rule-item advance-mode">
        <div class="rule-info">
          <span class="rule-name">Advance Search <span class="badge badge-advanced">ADVANCED</span></span>
          <span class="rule-desc"
            >Query all enabled providers simultaneously and combine results (enables all search providers)</span
          >
        </div>
        <label class="toggle-switch">
          <input
            type="checkbox"
            [checked]="rulesStore.rules()?.advanceSearch ?? false"
            (change)="toggleSessionRule('advanceSearch')"
          />
          <span class="slider"></span>
        </label>
      </div>
    </div>

    <!-- Content Extraction Section -->
    <div class="rules-section">
      <h3>Content Extraction</h3>
      <p class="section-description">Enable or disable methods for extracting content from URLs</p>

      <div class="rule-item">
        <div class="rule-info">
          <span class="rule-name">Tavily Extract <span class="badge badge-paid">API KEY</span></span>
          <span class="rule-desc">Cloud-based extraction (Requires API key in backend .env)</span>
        </div>
        <label class="toggle-switch">
          <input
            type="checkbox"
            [checked]="rulesStore.rules()?.tavilyExtract ?? false"
            (change)="toggleSessionRule('tavilyExtract')"
          />
          <span class="slider"></span>
        </label>
      </div>

      <div class="rule-item">
        <div class="rule-info">
          <span class="rule-name">Local Extract <span class="badge badge-free">FREE</span></span>
          <span class="rule-desc">Local content extraction using readability (No API key required)</span>
        </div>
        <label class="toggle-switch">
          <input
            type="checkbox"
            [checked]="rulesStore.rules()?.localExtract ?? false"
            (change)="toggleSessionRule('localExtract')"
          />
          <span class="slider"></span>
        </label>
      </div>

      <!-- Advance Extract Toggle -->
      <div class="rule-item advance-mode">
        <div class="rule-info">
          <span class="rule-name">Advance Extract <span class="badge badge-advanced">ADVANCED</span></span>
          <span class="rule-desc">Use both extraction methods and combine results (enables all extraction methods)</span>
        </div>
        <label class="toggle-switch">
          <input
            type="checkbox"
            [checked]="rulesStore.rules()?.advanceExtract ?? false"
            (change)="toggleSessionRule('advanceExtract')"
          />
          <span class="slider"></span>
        </label>
      </div>

      <!-- Customizable Limits Section -->
      <div class="rules-section">
        <h3>Custom Limits</h3>
        <p class="section-description">
          Override default limits for this session (leave blank to use defaults)
        </p>

        <div class="limit-item">
          <div class="limit-info">
            <span class="limit-name">Web Search Results</span>
            <span class="limit-desc">How many results to retrieve per search (default: 10)</span>
          </div>
          <input
            type="number"
            min="1"
            max="50"
            [value]="rulesStore.rules()?.webSearchLimit ?? ''"
            (blur)="updateLimit('webSearchLimit', $event)"
            placeholder="Default: 10"
            class="limit-input"
          />
        </div>

        <div class="limit-item">
          <div class="limit-info">
            <span class="limit-name">Memory Search Limit</span>
            <span class="limit-desc">How many memories to retrieve (default: 10)</span>
          </div>
          <input
            type="number"
            min="1"
            max="50"
            [value]="rulesStore.rules()?.memorySearchLimit ?? ''"
            (blur)="updateLimit('memorySearchLimit', $event)"
            placeholder="Default: 10"
            class="limit-input"
          />
        </div>

        <div class="limit-item">
          <div class="limit-info">
            <span class="limit-name">Conversation History Limit</span>
            <span class="limit-desc">How many previous messages to include (default: 10)</span>
          </div>
          <input
            type="number"
            min="1"
            max="50"
            [value]="rulesStore.rules()?.historyLimit ?? ''"
            (blur)="updateLimit('historyLimit', $event)"
            placeholder="Default: 10"
            class="limit-input"
          />
        </div>

        <div class="limit-item">
          <div class="limit-info">
            <span class="limit-name">File Upload Max Characters</span>
            <span class="limit-desc"
              >Maximum characters to extract from uploaded files (default: 50000)</span
            >
          </div>
          <input
            type="number"
            min="1000"
            max="500000"
            step="1000"
            [value]="rulesStore.rules()?.fileUploadMaxChars ?? ''"
            (blur)="updateLimit('fileUploadMaxChars', $event)"
            placeholder="Default: 50000"
            class="limit-input"
          />
        </div>
      </div>

      <!-- Custom Instructions Section -->
      <div class="rules-section">
        <h3>Custom AI Instructions</h3>
        <p class="section-description">
          Add custom behavior rules or instructions for the AI in this session
        </p>

        <div class="instructions-container">
          <div class="instructions-examples">
            <p class="examples-label">Examples:</p>
            <ul>
              <li>Don't act as a teacher, be more conversational</li>
              <li>Always cite sources with URLs</li>
              <li>Respond in bullet points instead of paragraphs</li>
              <li>Be more concise and technical</li>
              <li>Use simple language, avoid jargon</li>
            </ul>
          </div>

          <textarea
            class="instructions-textarea"
            [value]="rulesStore.rules()?.customInstructions ?? ''"
            (blur)="updateCustomInstructions($event)"
            placeholder="Enter custom instructions for this session...&#10;&#10;Examples:&#10;- Don't act as a teacher&#10;- Be more conversational&#10;- Provide code examples&#10;- Use bullet points"
            rows="6"
          ></textarea>

          <p class="instructions-help">
            These instructions will be added to the AI's system prompt for this session only. They
            override the default behavior.
          </p>
        </div>
      </div>
    </div>
  </div>
</div>
