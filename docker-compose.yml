services:
   mongo:
      image: mongo:7
      ports:
         - "27017:27017"
      volumes:
         - mongo_data:/data/db
      restart: unless-stopped

   searxng:
      image: searxng/searxng:latest
      ports:
         - "8080:8080"
      volumes:
         - ./searxng/settings.yml:/etc/searxng/settings.yml:ro
      restart: unless-stopped

   backend:
      build:
         context: ./backend
         dockerfile: Dockerfile
      environment:
         MONGO_URI: mongodb://mongo:27017
         DB_NAME: myslave
         OLLAMA_URL: ${OLLAMA_URL:-http://ollama:11434}
         OLLAMA_TIMEOUT: 120
         SEARXNG_URL: http://searxng:8080
         CORS_ORIGINS: '["http://localhost:4200","http://localhost:4000","http://localhost:4173"]'
         LOG_LEVEL: INFO
         SERPER_API_KEY: ${SERPER_API_KEY}
         TAVILY_API_KEY: ${TAVILY_API_KEY}
      ports:
         - "8000:8000"
      depends_on:
         - mongo
         - searxng
      restart: unless-stopped
      profiles:
         - prod-ssr
         - prod-spa

   backend-dev:
      build:
         context: ./backend
         dockerfile: Dockerfile
      environment:
         MONGO_URI: mongodb://mongo:27017
         DB_NAME: myslave
         OLLAMA_URL: ${OLLAMA_URL:-http://ollama:11434}
         OLLAMA_TIMEOUT: 120
         SEARXNG_URL: http://searxng:8080
         CORS_ORIGINS: '["http://localhost:4200"]'
         LOG_LEVEL: DEBUG
         SERPER_API_KEY: ${SERPER_API_KEY}
         TAVILY_API_KEY: ${TAVILY_API_KEY}
      command: >-
         uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
      ports:
         - "8000:8000"
      volumes:
         - ./backend:/app
      depends_on:
         - mongo
         - searxng
      restart: unless-stopped
      profiles:
         - dev

   frontend-ssr:
      build:
         context: ./frontend
         dockerfile: Dockerfile
         target: ssr
      environment:
         PORT: 4000
      ports:
         - "4000:4000"
      depends_on:
         - backend
      restart: unless-stopped
      profiles:
         - prod-ssr

   frontend-spa:
      build:
         context: ./frontend
         dockerfile: Dockerfile
         target: spa
      ports:
         - "4173:4173"
      depends_on:
         - backend
      restart: unless-stopped
      profiles:
         - prod-spa

   frontend-dev:
      build:
         context: ./frontend
         dockerfile: Dockerfile
         target: dev
      ports:
         - "4200:4200"
      volumes:
         - ./frontend:/app
         - /app/node_modules
      depends_on:
         - backend-dev
      restart: unless-stopped
      profiles:
         - dev

   ollama:
      image: ollama/ollama:latest
      ports:
         - "11434:11434"
      volumes:
         - ollama_data:/root/.ollama
      restart: unless-stopped
      profiles:
         - ollama-cpu
      command: serve

   ollama-gpu:
      image: ollama/ollama:latest
      profiles:
         - ollama-gpu
      ports:
         - "11434:11434"
      volumes:
         - ollama_data:/root/.ollama
      deploy:
         resources:
            reservations:
               devices:
                  - driver: nvidia
                    count: all
                    capabilities: [gpu]
      command: serve
         

volumes:
   mongo_data:
   ollama_data: